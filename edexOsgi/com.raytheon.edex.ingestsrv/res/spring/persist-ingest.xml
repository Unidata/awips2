<beans
  xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
  http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
  http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd">


    <bean id="uriAggregator" class="com.raytheon.uf.edex.esb.camel.DataUriAggregator" />
    <bean id="toDataURI" class="com.raytheon.uf.edex.esb.camel.ToDataURI" />

    <bean id="dupElim" class="com.raytheon.edex.ingestsrv.DupElimSrv"/>
    <bean id="persist" class="com.raytheon.edex.services.PersistSrv" factory-method="getInstance" />
    <bean id="index" class="com.raytheon.edex.services.IndexSrv" />

    <bean id="persistCamelRegistered" factory-bean="contextManager" factory-method="register">
        <constructor-arg ref="persist-camel" />
    </bean>

    <camelContext id="persist-camel" xmlns="http://camel.apache.org/schema/spring"
        errorHandlerRef="errorHandler">

        <!-- Generic persist and indexing
                 Intended for routes that need persisting to HDF5,
                 Indexing but no alert processing -->
        <route id="persistIndex">
            <from uri="direct-vm:persistIndex" />
            <doTry>
                <bean ref="persist" method="persist" />
                <bean ref="index" method="index" />
                <bean ref="processUtil" method="log" />
                <doCatch>
                    <exception>java.lang.Throwable</exception>
                    <to uri="log:persist?level=ERROR" />
                </doCatch>
            </doTry>
        </route>

        <!-- Generic persist, index and alert route
                 Intended for routes that need persisting to HDF5, 
                 Indexing and Alerting
        -->
        <route id="persistIndexAlert">
            <from uri="direct-vm:persistIndexAlert" />
            <doTry>
                <bean ref="persist" method="persist" />
                <bean ref="index" method="index" />
                <bean ref="processUtil" method="log" />
                <bean ref="toDataURI" method="toDataURI" />
                <to uri="vm:stageNotification" />
                <doCatch>
                    <exception>java.lang.Throwable</exception>
                    <to uri="log:persist?level=ERROR" />
                </doCatch>
            </doTry>
        </route>

        <!-- Generic index and alert route
                 Intended for routes that need Indexing and Alerting
        -->
        <route id="indexAlert">
            <from uri="direct-vm:indexAlert" />
            <doTry>
                <bean ref="index" method="index" />
                <bean ref="processUtil" method="log" />
                <bean ref="toDataURI" method="toDataURI" />
                <to uri="vm:stageNotification" />
                <doCatch>
                    <exception>java.lang.Throwable</exception>
                    <to uri="log:persist?level=ERROR" />
                </doCatch>
            </doTry>
        </route>

        <route id="notificationAggregation">
            <from uri="vm:stageNotification" />
            <bean ref="uriAggregator" method="addDataUris" />
        </route>

        <route id="notificationTimer">
            <from uri="timer://notificationTimer?fixedRate=true&amp;period=5000" />
            <filter>
                <method bean="uriAggregator" method="hasUris" />
                <bean ref="uriAggregator" method="sendQueuedUris" />
                <bean ref="serializationUtil" method="transformToThrift" />
                <to uri="jms-generic:topic:edex.alerts?timeToLive=60000" />
            </filter>
        </route>
    </camelContext>
</beans>